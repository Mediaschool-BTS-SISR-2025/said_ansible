---
# Installation des dépendances
- name: Installation d'iptables et iptables-persistent
  apt:
    name:
      - iptables-persistent
    state: present
    update_cache: yes

# Sauvegarde des règles existantes
- name: Sauvegarde des règles existantes
  shell: iptables-save > /root/iptables.bak
  changed_when: false

# Réinitialiser le pare-feu pour Docker
- name: Réinitialiser les règles iptables pour Docker
  shell: |
    iptables -P INPUT ACCEPT
    iptables -P FORWARD ACCEPT
    iptables -P OUTPUT ACCEPT
    iptables -F
  changed_when: true

# Redémarrer Docker pour qu'il crée ses chaînes
- name: Redémarrer Docker pour recréer ses chaînes
  systemd:
    name: docker
    state: restarted

# Attendre que Docker soit prêt
- name: Attendre que Docker soit prêt
  wait_for:
    timeout: 10

# Appliquer les règles de base en préservant les chaînes Docker
- name: Appliquer les règles de base
  iptables:
    chain: INPUT
    protocol: "{{ item.protocol }}"
    destination_port: "{{ item.port }}"
    jump: ACCEPT
  with_items:
    - { protocol: tcp, port: 22 }
    - { protocol: tcp, port: 80 }
    - { protocol: tcp, port: 443 }

# Autoriser le loopback
- name: Autoriser le trafic loopback
  iptables:
    chain: INPUT
    in_interface: lo
    jump: ACCEPT

# Autoriser les connexions établies
- name: Autoriser les connexions établies
  iptables:
    chain: INPUT
    ctstate: ESTABLISHED,RELATED
    jump: ACCEPT

# Politique par défaut pour INPUT
- name: Configurer la politique par défaut pour INPUT
  iptables:
    chain: INPUT
    policy: DROP

# Sauvegarder les règles
- name: Sauvegarder les règles iptables
  shell: netfilter-persistent save
  changed_when: true